name: Build Custom PiOS Image

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Git branch to build'
        required: true
        default: 'master'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout selected branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-user-static binfmt-support kpartx dosfstools debootstrap \
          xz-utils unzip wget jq

    - name: Restore cached PiOS image
      id: cache-pios
      uses: actions/cache@v4
      with:
        path: image/raspios-bullseye-arm64-lite.img.xz
        key: raspios-bullseye-arm64-lite

    - name: Download PiOS image if cache miss
      if: steps.cache-pios.outputs.cache-hit != 'true'
      run: |
        mkdir -p image
        wget -O image/raspios-bullseye-arm64-lite.img.xz \
          https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2023-05-03/2023-05-03-raspios-bullseye-arm64-lite.img.xz

    - name: Save PiOS image to cache
      if: steps.cache-pios.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: image/raspios-bullseye-arm64-lite.img.xz
        key: raspios-bullseye-arm64-lite

    - name: Extract image
      run: |
        xz -dk image/raspios-bullseye-arm64-lite.img.xz

    - name: Expand root filesystem in image
      run: |
        sudo apt-get install -y parted e2fsprogs
        IMG="image/raspios-bullseye-arm64-lite.img"

        # Grow image file by 1G
        truncate -s +1G "$IMG"

        # Tell parted to script without prompts and expand partition 2
        sudo parted -s "$IMG" resizepart 2 100%

        # Setup loop device
        LOOP_DEV=$(sudo losetup -fP --show "$IMG")

        # Run e2fsck non-interactively
        sudo e2fsck -fy "${LOOP_DEV}p2"

        # Resize filesystem to fill partition
        sudo resize2fs "${LOOP_DEV}p2"

        # Cleanup
        sudo losetup -d "$LOOP_DEV"

    - name: Download .deb files from latest release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        mkdir -p debs
        for FILE in rc-python.deb v3xctrl.deb; do
          url=$(curl -s -H "Authorization: token $GH_TOKEN" \
              https://api.github.com/repos/${REPO}/releases/latest \
              | jq -r ".assets[] | select(.name == \"${FILE}\") | .url")

          if [ -z "$url" ]; then
            echo "Error: $FILE not found in latest release"
            exit 1
          fi

          curl -L -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/octet-stream" "$url" \
               -o "debs/$FILE"
        done

    - name: Customize PiOS image
      run: |
        sudo ./bash/customize-image.sh image/raspios-bullseye-arm64-lite.img debs

    - name: Compress final image
      run: |
        XZ_OPT="--no-sparse" xz -T0 -f image/v3xctrl-raspios.img

    - name: Upload final image
      uses: actions/upload-artifact@v4
      with:
        name: custom-raspios-image
        path: image/v3xctrl-raspios.img.xz
