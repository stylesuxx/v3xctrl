name: Build Custom PiOS Image

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Git branch to build'
        required: true
        default: 'master'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout selected branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: Load version configuration
      run: |
        source build/versions.env
        echo "PIOS_IMAGE_URL=$PIOS_IMAGE_URL" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget jq qemu-user-static

    - name: Restore cached PiOS image
      id: cache-pios
      uses: actions/cache@v4
      with:
        path: image/raspios-arm64-lite.img.xz
        key: raspios-arm64-lite.img.xz

    - name: Download PiOS image if cache miss
      if: steps.cache-pios.outputs.cache-hit != 'true'
      run: |
        mkdir -p image
        wget -O image/raspios-arm64-lite.img.xz ${{ env.PIOS_IMAGE_URL }}

    - name: Save PiOS image to cache
      if: steps.cache-pios.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: image/raspios-arm64-lite.img.xz
        key: raspios-arm64-lite.img.xz

    - name: Download .deb files from latest release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        mkdir -p debs
        for FILE in v3xctrl-python.deb v3xctrl.deb; do
          url=$(curl -s -H "Authorization: token $GH_TOKEN" \
              https://api.github.com/repos/${REPO}/releases/latest \
              | jq -r ".assets[] | select(.name == \"${FILE}\") | .url")

          if [ -z "$url" ]; then
            echo "Error: $FILE not found in latest release"
            exit 1
          fi

          curl -L -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/octet-stream" "$url" \
               -o "debs/$FILE"
        done

    - name: Customize PiOS image
      run: |
        sudo ./build/customize-image.sh mnt image/raspios-arm64-lite.img.xz debs image/v3xctrl-raspios.img.xz

    - name: Upload final image
      uses: actions/upload-artifact@v4
      with:
        name: v3xctrl-raspios
        path: image/v3xctrl-raspios.img.xz

  call-cleanup:
    name: Cleanup old workflow runs
    needs: build
    uses: ./.github/workflows/cleanup-old-runs.yml
    with:
      branch: ${{ github.event.inputs.branch }}
      keep_run_id: ${{ github.run_id }}
      workflow_name: ${{ github.workflow }}
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}
