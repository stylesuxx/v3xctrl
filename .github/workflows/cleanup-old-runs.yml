name: Cleanup Old Workflow Runs

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      keep_run_id:
        required: true
        type: string
      workflow_name:
        required: true
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh jq

      - name: Cleanup old workflow runs on branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up workflow: ${{ inputs.workflow_name }}"
          echo "On branch: ${{ inputs.branch }}"
          echo "Keeping current run ID: ${{ inputs.keep_run_id }}"

          # Get workflow ID
          WORKFLOW_ID=$(gh api -X GET "/repos/${{ github.repository }}/actions/workflows" \
            --jq ".workflows[] | select(.name==\"${{ inputs.workflow_name }}\") | .id")

          # Get recent runs on this branch
          gh api -X GET "/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?branch=${{ inputs.branch }}&per_page=100" \
            > runs.json

          # Find most recent successful run (excluding current one)
          LATEST_SUCCESS_ID=$(jq "[.workflow_runs[] | select(.conclusion==\"success\" and .id != ${{ inputs.keep_run_id }})][0].id" runs.json)

          echo "Latest successful run ID: $LATEST_SUCCESS_ID"

          jq -r --argjson keep1 "${{ inputs.keep_run_id }}" --argjson keep2 "$LATEST_SUCCESS_ID" \
            '.workflow_runs[] | select(.id != $keep1 and .id != $keep2) | .id' runs.json | while read run_id; do
            echo "Deleting run $run_id"
            gh api -X DELETE "/repos/${{ github.repository }}/actions/runs/$run_id"
          done
