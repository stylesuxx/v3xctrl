#!/bin/bash

if ! id -u rc-user >/dev/null 2>&1; then
  useradd --system --no-create-home --shell /usr/sbin/nologin rc-user
  sudo usermod -aG video rc-user
fi

chown rc-user:rc-user /etc/rc-client
chown rc-user:rc-user /etc/rc-client/*.json
chmod a+r /etc/rc-client/config.json

RECORD_DIR="/var/lib/rc-client/recordings"
if [ ! -d "$RECORD_DIR" ]; then
    mkdir -p "$RECORD_DIR"
    chown rc-user:rc-user "$RECORD_DIR"
    chmod a+rw "$RECORD_DIR"
fi

if command -v systemctl >/dev/null 2>&1; then
  systemctl daemon-reload

  # Disable services that we don not need or are handled by other services
  systemctl disable \
    dhcpcd \
    wpa_supplicant \
    hostapd \
    dnsmasq \
    bluetooth \
    rpi-eeprom-update \
    rsync \
    triggerhappy triggerhappy.socket \
    udisks2 \
    apt-daily.timer apt-daily-upgrade.timer \
    man-db.timer \
    e2scrub_all.timer e2scrub_reap \
    fstrim.timer \
    rsyslog \
    rpi-display-backlight \
    remote-fs.target \
    nfs-client.target

  systemctl enable \
    rc-config-server \
    rc-service-manager \
    rc-wifi-mode

  systemctl restart rc-config-server
fi
