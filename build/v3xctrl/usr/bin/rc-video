#! /bin/bash
NAME="v3xctrl"
CONFIG_PATH="/etc/${NAME}/config.json"

# TODO: We need to have an extra script to read host and port, since it could be
#       static or set via rendezvouz server.
HOST=$(jq -r '.server.host' "$CONFIG_PATH")
PORT=$(jq -r '.ports.video' "$CONFIG_PATH")

WIDTH=$(jq -r '.video.width' "$CONFIG_PATH")
HEIGHT=$(jq -r '.video.height' "$CONFIG_PATH")
FRAMERATE=$(jq -r '.video.framerate' "$CONFIG_PATH")
BITRATE=$(jq -r '.video.bitrate' "$CONFIG_PATH")

RECORD=$(jq -r '.video.record' "$CONFIG_PATH")
RECORD_PATH=$(jq -r '.video.recordPath' "$CONFIG_PATH")

TEST_SOURCE=$(jq -r '.video.testSource' "$CONFIG_PATH")

ARGS=(
  "$HOST"
  "$PORT"
  --width "$WIDTH"
  --height "$HEIGHT"
  --framerate "$FRAMERATE"
  --bitrate "$BITRATE"
)

if [ "$RECORD" = "true" ] && [ -n "$RECORD_PATH" ] && [ "$RECORD_PATH" != "null" ]; then
  ARGS+=(--recording-dir "$RECORD_PATH")
fi

if [ "$TEST_SOURCE" = "true" ]; then
  ARGS+=(--test-pattern)
fi

/usr/share/${NAME}/gst/transmit-stream.sh "${ARGS[@]}"
