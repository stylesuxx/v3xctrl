#!/bin/bash
set -euo pipefail

NAME=$0
CMDLINE="/boot/cmdline.txt"
CMDLINE_CONTENT=$(cat "$CMDLINE")
FSTAB="/etc/fstab"
JOURNALD_CONF="/etc/systemd/journald.conf"

if [[ "$EUID" -ne 0 ]]; then
  echo "Please run as root"
  exit 1
fi

if [[ $# -ne 1 || ( "$1" != "ro" && "$1" != "rw" ) ]]; then
  echo "Usage: $0 [ro|rw]"
  exit 1
fi

TARGET="$1"

# Ensure /boot is writable before editing cmdline.txt
echo "[${NAME}] Ensuring /boot is writable..."
if mountpoint -q /boot; then
  mount_opts=$(findmnt -n -o OPTIONS /boot)
  if echo "$mount_opts" | grep -q '\<ro\>'; then
    echo "[${NAME}] Remounting /boot as rw for modification..."
    mount -o remount,rw /boot
  fi
fi

if [[ "$TARGET" == "ro" ]]; then
  if ! grep -qw 'boot=overlay' "$CMDLINE"; then
    echo "[${NAME}] Enabling overlay (read-only)..."
    echo "boot=overlay $CMDLINE_CONTENT" > "$CMDLINE"
  else
    echo "[${NAME}] Overlay already enabled."
  fi
fi

if [[ "$TARGET" == "rw" ]]; then
  if grep -qw 'boot=overlay' "$CMDLINE"; then
    echo "[${NAME}] Disabling overlay (read-write)..."
    sed -i 's/\bboot=overlay\b//' "$CMDLINE"
  else
    echo "[${NAME}] Overlay already disabled."
  fi
fi

echo "[${NAME}] Updating /etc/fstab mount options for /boot..."
sed -i -E \
  "s|^(\s*PARTUUID=[^[:space:]]+\s+/boot\s+vfat\s+)[^[:space:]]+|\1${TARGET}|" \
  "$FSTAB"

echo "[${NAME}] Updating journald.conf for $TARGET mode..."
if [[ "$TARGET" == "rw" ]]; then
  if grep -Eq '^\s*#?\s*Storage=' "$JOURNALD_CONF"; then
    sed -i -E 's|^\s*#?\s*Storage=.*|Storage=persistent|' "$JOURNALD_CONF"
  else
    echo 'Storage=persistent' >> "$JOURNALD_CONF"
  fi
else
  sed -i -E 's|^\s*(Storage=.*)|#\1|' "$JOURNALD_CONF"
fi

echo "[${NAME}] Done! Overlay mode set to $TARGET. Reboot to apply."
