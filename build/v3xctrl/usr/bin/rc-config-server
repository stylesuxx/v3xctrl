#! /bin/bash
# Bind config server to wlan0 IP if available, otherwise bind to 127.0.0.1
NAME="v3xctrl
CONFIG_PATH="/etc/${NAME}/config.json"
SCHEMA_PATH="/etc/${NAME}/schema.json"

get_wlan0_ip() {
  ip -4 addr show wlan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'
}

PORT=$(jq -r '.ports.webinterface' "$CONFIG_PATH")
HOST=$(get_wlan0_ip)
if [ -z "$HOST" ]; then
  HOST="127.0.0.1"
fi

rc-python "/usr/share/${NAME}/config-server/main.py" \
  --config "$CONFIG_PATH" \
  --schema "$SCHEMA_PATH" \
  --host "$HOST" \
  --port "$PORT"
