#!/bin/bash
# Meant to be run on first boot, this script will create a data partition which
# will be used to store recordings and the config files.
# - This partition will be RW
# - It will copy the v3xctrl config to this new data partition
# - It will configure / and /root to be read-only
# - It will set up tmpfs for directories that need to be writable (but non
#   persistent) during runtime.
set -e

USER="v3xctrl"
DISK="/dev/mmcblk0"
RECORDING_DIR="/data/recordings"
TMPFS_ENTRIES=(
    "/tmp tmpfs tmpfs defaults,noatime,nosuid,size=16m 0 0"
    "/var/tmp tmpfs tmpfs defaults,noatime,nosuid,size=16m 0 0"
)

DATA_PART_NUM=3
DATA_PART="${DISK}p${DATA_PART_NUM}"

echo "[*] Expanding /data partition to use remaining space..."
DATA_START=$(cat "/sys/block/mmcblk0/mmcblk0p3/start")
echo -e "d\n${DATA_PART_NUM}\nn\np\n${DATA_PART_NUM}\n${DATA_START}\n\nw" | fdisk "$DISK"

partprobe "$DISK"

# Wait for /dev/mmcblk0p3 to reappear
for i in {1..10}; do
    [ -b "$DATA_PART" ] && break
    sleep 0.5
done

if [ ! -b "$DATA_PART" ]; then
    echo "ERROR: Partition $DATA_PART not found after resize"
    exit 1
fi

# Format it as ext4
echo "[*] Formatting /data as ext4..."
mkfs.ext4 "$DATA_PART"

echo "[*] Adding partition to fstab and mounting..."
mkdir -p /data
PARTUUID=$(blkid -s PARTUUID -o value "$DATA_PART")
if ! grep -q '/data' /etc/fstab; then
    echo "PARTUUID=$PARTUUID /data ext4 defaults 0 2" >> /etc/fstab
fi
mount /data

# Create structure for data partition
mkdir -p /data/log
mkdir -p /data/config
mkdir -p "${RECORDING_DIR}"

chown $USER:$USER "${RECORDING_DIR}"
chmod a+rw "${RECORDING_DIR}"

echo "[*] Moving config and symlinking..."
if [ -f /etc/v3xctrl/config.json ] && [ ! -f /data/config/config.json ]; then
    mv /etc/v3xctrl/config.json /data/config/config.json
    ln -s /data/config/config.json /etc/v3xctrl/config.json
fi

echo "[*] Symlinking log dir..."
if [ -d /var/log ] && [ ! -L /var/log ]; then
    rm -rf /var/log
    ln -s /data/log /var/log
fi

echo "[*] Creating tmpfs mounts..."
for entry in "${TMPFS_ENTRIES[@]}"; do
    mountpoint=$(echo "$entry" | awk '{print $1}')
    if ! grep -q "$mountpoint" /etc/fstab; then
        echo "$entry" >> /etc/fstab
    fi
done

echo "[*] Setting /boot and / to readonly..."
sed -i 's|^\(PARTUUID=[^ ]\+\s\+/boot\s\+\)vfat\s\+\S\+|\1vfat ro|' /etc/fstab
sed -i 's|^\(PARTUUID=[^ ]\+\s\+/\s\+\)ext4\s\+\S\+|\1ext4 ro,noatime|' /etc/fstab

echo "[*] Setup complete"
