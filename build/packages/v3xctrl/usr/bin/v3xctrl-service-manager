#! /bin/bash
# Start video and control services if autostart is enabled
set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

SUBDEV_0="/dev/v4l-subdev0"

# Stop video & control service
if [ "$autostart_video" = "true" ]; then
  echo "Stopping video service..."
  systemctl stop v3xctrl-video
fi

if [ "$autostart_control" = "true" ]; then
  echo "Stopping control service..."
  systemctl stop v3xctrl-control
fi

# RPi-cam v3 related settings
if [ -e "$SUBDEV_0" ]; then

  # Set WDR if control available
  CONTROL="wide_dynamic_range"
  if v4l2-ctl -d "$SUBDEV_0" --list-ctrls | grep -q "$CONTROL"; then
    WIDE_DYNAMIC_RANGE=0
    if [ "$video_camera_enableHdr" = "true" ]; then
      echo "Enable HDR mode..."
      WIDE_DYNAMIC_RANGE=1
    else
      echo "Disable HDR mode..."
    fi

    v4l2-ctl -d "$SUBDEV_0" --set-ctrl "$CONTROL=$WIDE_DYNAMIC_RANGE"
  fi
fi

if [ "$network_modem_limitBands" = "true" ]; then
  echo "Limiting bands..."
  v3xctrl-set-bands $network_modem_allowedBands
fi

if [ "$extras_samba" = "true" ]; then
  echo "Starting samba service..."
  systemctl start smbd
fi

if [ "$extras_logLevel" = "DEBUG" ]; then
  echo "Starting debug log service..."
  systemctl start v3xctrl-debug-log
fi

# Setup rendezvous/relay servers if not in direct connection mode
if [ "$server_mode" = "rendezvous" ]; then
  echo "Registering with rendezvous server..."
  v3xctrl-rendezvous
fi

if [ "$server_mode" = "relay" ]; then
  echo "Registering with relay server..."
  v3xctrl-relay
fi

# Start video & control service
if [ "$autostart_video" = "true" ]; then
  echo "Starting video service..."
  systemctl start v3xctrl-video
fi

if [ "$autostart_control" = "true" ]; then
  echo "Starting control service..."
  systemctl start v3xctrl-control
fi

exit 0
