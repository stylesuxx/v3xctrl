#! /bin/bash
# Start video and control services if autostart is enabled
set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

# Stop video & control service
if [ "$video_autostart" = "true" ]; then
  echo "Stopping video service..."
  systemctl stop v3xctrl-video
fi

if [ "$control_autostart" = "true" ]; then
  echo "Stopping control service..."
  systemctl stop v3xctrl-control
fi

if [ "$network_modem_limitBands" = "true" ]; then
  echo "Limiting bands..."
  v3xctrl-set-bands $network_modem_allowedBands
else
  echo "Setting default bands..."
  v3xctrl-modem-reset-bands
fi

if [ "$network_extras_samba" = "true" ]; then
  echo "Starting samba service..."
  systemctl start smbd
fi

if [ "$development_logLevel" = "DEBUG" ]; then
  echo "Starting debug log service..."
  systemctl start v3xctrl-debug-log
fi

# Setup rendezvous/relay servers if not in direct connection mode
if [ "$server_mode" = "rendezvous" ]; then
  echo "Registering with rendezvous server..."
  v3xctrl-rendezvous
fi

if [ "$server_mode" = "relay" ]; then
  echo "Registering with relay server..."
  v3xctrl-relay
fi

# Start video & control service
if [ "$video_autostart" = "true" ]; then
  echo "Starting video service..."
  systemctl start v3xctrl-video
fi

if [ "$control_autostart" = "true" ]; then
  echo "Starting control service..."
  systemctl start v3xctrl-control
fi

exit 0
