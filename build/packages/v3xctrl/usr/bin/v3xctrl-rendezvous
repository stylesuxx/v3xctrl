#!/bin/bash
set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

json=$(
  v3xctrl-python -m v3xctrl_punch.apps.getServerInfo \
    "${server_rendezvousServer}" "${server_rendezvousId}" \
    --port 8888 \
    --port-video "${network_ports_video_bind}" \
    --port-control "${network_ports_control_bind}" \
    --log "${extras_logLevel}"
)

server_host=$(echo "$json" | jq -r '.server.host')
network_ports_video=$(echo "$json" | jq -r '.network.ports.video')
network_ports_control=$(echo "$json" | jq -r '.network.ports.control')

sed -i \
  -e "s/^server_host=.*/server_host=${server_host}/" \
  -e "s/^network_ports_video=.*/network_ports_video=${network_ports_video}/" \
  -e "s/^network_ports_control=.*/network_ports_control=${network_ports_control}/" \
  "$ENV_PATH"