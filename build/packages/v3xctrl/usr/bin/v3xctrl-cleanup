#!/bin/bash
# This script is used to recover from an unclean shutdown. It handles the
# following things:
# 1. Remove lock file for dhcpcd, wpa_supplicant

handle_dhcpcd_issues() {
  if ! systemctl is-active --quiet dhcpcd; then
      rm -fv "/var/lib/dhcpcd5/"*.lease
      rm -fv /var/lib/dhcpcd5/dhcpcd.duid
      rm -fv /run/dhcpcd.pid
  fi
}

handle_wpa_supplicant_issues() {
  if ! systemctl is-active --quiet wpa_supplicant; then
    rm -fv "/run/wpa_supplicant/"*.pid
    rm -fv "/var/run/wpa_supplicant/"*.pid
    rm -fv /run/wpa_supplicant/wlan0
    rm -fv /var/run/wpa_supplicant/wlan0
  fi
}

handle_hostapd_issues() {
  if ! systemctl is-active --quiet hostapd; then
    LOCK_FILES=("/run/hostapd.pid" "/var/run/hostapd.pid")
    for file in "${LOCK_FILES[@]}"; do
      if [ -f "$file" ]; then
        rm -fv "$file"
      fi
    done
  fi
}

handle_dhcpcd_issues
handle_wpa_supplicant_issues
handle_hostapd_issues
