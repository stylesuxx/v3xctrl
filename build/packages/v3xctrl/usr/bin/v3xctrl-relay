#!/bin/bash
set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

relay_host="${network_server_relay_host}"
extra_args=()

# Split host:port if provided
if [[ "$network_server_relay_host" == *:* ]]; then
  relay_host="${network_server_relay_host%%:*}"
  relay_port="${network_server_relay_host##*:}"
  extra_args+=(--port "$relay_port")
fi

json=$(
  v3xctrl-python -m v3xctrl_udp_relay.apps.getRelayInfo \
    "$relay_host" "$network_server_relay_sessionId" \
    --port-video "$network_server_ports_video_bind" \
    --port-control "$network_server_ports_control_bind" \
    --log "$development_logLevel" \
    "${extra_args[@]}"
)

network_server_direct_host=$(echo "$json" | jq -r '.network.server.direct.host')
network_server_ports_video=$(echo "$json" | jq -r '.network.server.ports.video')
network_server_ports_control=$(echo "$json" | jq -r '.network.server.ports.control')

sed -i \
  -e "s/^network_server_direct_host=.*/network_server_direct_host=${network_server_direct_host}/" \
  -e "s/^network_server_ports_video=.*/network_server_ports_video=${network_server_ports_video}/" \
  -e "s/^network_server_ports_control=.*/network_server_ports_control=${network_server_ports_control}/" \
  "$ENV_PATH"
