#! /bin/bash
# Bind config server to wlan0 IP if available, otherwise bind to 127.0.0.1
ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

CONFIG_PATH="/etc/${NAME}/config.json"
SCHEMA_PATH="/etc/${NAME}/schema.json"
MODEMS_PATH="/etc/${NAME}/modems.json"

get_wlan0_ip() {
  ip -4 addr show wlan0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'
}

HOST=$(get_wlan0_ip)
if [ -z "$HOST" ]; then
  HOST="127.0.0.1"
fi

v3xctrl-python "/usr/share/${NAME}/config-server/main.py" \
  --config "$CONFIG_PATH" \
  --schema "$SCHEMA_PATH" \
  --modems "$MODEMS_PATH" \
  --host "$HOST" \
  --port "$network_ports_webinterface"
