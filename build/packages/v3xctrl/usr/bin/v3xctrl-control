#!/bin/bash
set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

ARGS=""
if [ "$control_steering_invert" = "true" ]; then
  ARGS+="--steering-invert"
fi

v3xctrl-python -m v3xctrl_control.apps.streamer "${server_direct_host}" "${server_ports_control}" "${server_ports_control_bind}" \
  --throttle-min "${control_throttle_min}" \
  --throttle-max "${control_throttle_max}" \
  --throttle-idle "${control_throttle_idle}" \
  --forward-scale "${control_throttle_scaleForward}" \
  --reverse-scale "${control_throttle_scaleReverse}" \
  --forward-boost "${control_throttle_minForward}" \
  --reverse-boost "${control_throttle_minReverse}" \
  --steering-min "${control_steering_min}" \
  --steering-max "${control_steering_max}" \
  --steering-trim "${control_steering_trim}" \
  --steering-scale "${control_steering_scale}" \
  --failsafe-ms "${control_failsafeTimeout}" \
  --failsafe-throttle "${control_throttle_failsafe}" \
  --failsafe-steering "${control_steering_failsafe}" \
  --pwm-channel-throttle "${control_pwm_throttle}" \
  --pwm-channel-steering "${control_pwm_steering}" \
  --modem-path "${network_modem_path}" \
  --log "${development_logLevel}" \
  --battery-min-voltage "${control_telemetry_battery_minVoltage}" \
  --battery-max-voltage "${control_telemetry_battery_maxVoltage}" \
  --battery-warn-voltage "${control_telemetry_battery_warnVoltage}" \
  --battery-i2c-address "${control_telemetry_battery_i2cAddress}" \
  ${ARGS}
