#!/bin/bash
set -e

ENV_PATH="/run/v3xctrl.env"

# Note: /etc/v3xctrl is bind-mounted to /data/config by etc-v3xctrl.mount
# This ensures the config persists across RO/RW modes
CONFIG_PATH="/etc/v3xctrl/config.json"

# Export everything except modem.allowedBands
jq -r '
  paths(scalars) as $p |
  select($p != ["network", "modem", "allowedBands"] and ($p[0:3] != ["network", "modem", "allowedBands"])) |
  [($p | map(tostring) | join("_")), (getpath($p))] |
  "\(.[0])=\(.[1])"
' "$CONFIG_PATH" > "$ENV_PATH"

# Append network.modem.allowedBands as comma-separated string
jq -r '
  .network.modem.allowedBands?
  | select(type == "array")
  | "network_modem_allowedBands=" + (join(","))
' "$CONFIG_PATH" >> "$ENV_PATH"

source "${ENV_PATH}"

# Custom adaptations that are not part of the config JSON
echo "network_server_ports_video_bind=${network_server_ports_video}" >> "${ENV_PATH}"
echo "network_server_ports_control_bind=${network_server_ports_control}" >> "${ENV_PATH}"
echo "NAME=v3xctrl" >> "${ENV_PATH}"
