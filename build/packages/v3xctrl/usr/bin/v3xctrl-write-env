#!/bin/bash
set -e

ENV_PATH="/run/v3xctrl.env"
CONFIG_PATH="/etc/v3xctrl/config.json"
CONFIG_PATH_RO="/data/config/config.json"

# Ensure symlink if root is read-only and CONFIG_PATH_RO exists
if findmnt -n -o FSTYPE / | grep -q '^overlay$' && [ -f "$CONFIG_PATH_RO" ]; then
  if [ ! -L "$CONFIG_PATH" ] || [ "$(readlink -f "$CONFIG_PATH")" != "$CONFIG_PATH_RO" ]; then
    echo "Creating symlink: $CONFIG_PATH -> $CONFIG_PATH_RO"
    rm -f "$CONFIG_PATH"
    ln -s "$CONFIG_PATH_RO" "$CONFIG_PATH"
    chown v3xctrl:v3xctrl "$CONFIG_PATH"
    chmod a+r "$CONFIG_PATH"
  fi
fi

# Export everything except modem.allowedBands
jq -r '
  paths(scalars) as $p |
  select($p != ["network", "modem", "allowedBands"] and ($p[0:3] != ["network", "modem", "allowedBands"])) |
  [($p | map(tostring) | join("_")), (getpath($p))] |
  "\(.[0])=\(.[1])"
' "$CONFIG_PATH" > "$ENV_PATH"

# Append network.modem.allowedBands as comma-separated string
jq -r '
  .network.modem.allowedBands?
  | select(type == "array")
  | "network_modem_allowedBands=" + (join(","))
' "$CONFIG_PATH" >> "$ENV_PATH"

source "${ENV_PATH}"

# Custom adaptations that are not part of the config JSON
echo "network_ports_video_bind=${network_ports_video}" >> "${ENV_PATH}"
echo "network_ports_control_bind=${network_ports_control}" >> "${ENV_PATH}"
echo "NAME=v3xctrl" >> "${ENV_PATH}"
