#! /bin/bash
set -e

# Parse command line arguments
FILE_SRC=""
while [[ $# -gt 0 ]]; do
  case $1 in
    --file-src)
      FILE_SRC="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

ARGS=(
  "$server_host"
  "$network_ports_video"
  "$network_ports_video_bind"
  --width "$video_width"
  --height "$video_height"
  --framerate "$video_framerate"
  --bitrate "$video_bitrate"
  --i-frame-period "$video_iFramePeriod"
  --qp-minimum "$video_qp_min"
  --qp-maximum "$video_qp_max"
  --max-i-frame-bytes "$video_maxIframeBytes"
  --af-mode "$video_camera_afMode"
  --lens-position "$video_camera_lensPosition"
  --analogue-gain-mode "$video_camera_analogueGainMode"
  --analogue-gain "$video_camera_analogueGain"
  --exposure-time-mode "$video_camera_exposureTimeMode"
  --exposure-time "$video_camera_exposureTime"
  --log "${extras_logLevel}"
)

if [ -n "$video_recordPath" ] && [ "$video_recordPath" != "null" ]; then
  ARGS+=(--recording-dir "$video_recordPath")

  if [ "$video_record" = "true" ]; then
    ARGS+=(--autostart-recording)
  fi
fi

if [ "$video_enableIframeAdjust" = "true" ]; then
  ARGS+=(--enable-i-frame-adjust)
fi

if [ "$video_testSource" = "true" ]; then
  ARGS+=(--test-pattern)
fi

if [ -n "$FILE_SRC" ]; then
  ARGS+=(--file-src "$FILE_SRC")
fi

v3xctrl-python -m v3xctrl_gst.apps.streamer "${ARGS[@]}"
