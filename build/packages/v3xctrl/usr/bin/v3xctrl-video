#! /bin/bash
set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

ARGS=(
  "$server_host"
  "$network_ports_video"
  "$network_ports_video_bind"
  --width "$video_width"
  --height "$video_height"
  --framerate "$video_framerate"
  --bitrate "$video_bitrate"
  --i-frame-period "$video_iFramePeriod"
  --qp-minimum "$video_qp_min"
  --qp-maximum "$video_qp_max"
  --max-i-frame-bytes "$video_maxIframeBytes"
  --log "${extras_logLevel}"
)

if [ "$video_record" = "true" ] && [ -n "$video_recordPath" ] && [ "$video_recordPath" != "null" ]; then
  ARGS+=(--recording-dir "$video_recordPath")
fi

if [ "$video_enableIframeAdjust" = "true" ]; then
  ARGS+=(--enable-i-frame-adjust)
fi

if [ "$video_testSource" = "true" ]; then
  ARGS+=(--test-pattern)
fi

v3xctrl-python -m v3xctrl_gst.apps.streamer "${ARGS[@]}"
