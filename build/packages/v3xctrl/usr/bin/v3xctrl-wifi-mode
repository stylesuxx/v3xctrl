#!/bin/bash

# Make sure dhcpcd service is disabled!
#
# We either blacklist or enable wlan0 from dhcpcd.conf, but we will start it in
# any case, so all other devices will get an IP via DHCP.

set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

INTERFACE="wlan0"
SUBNET="192.168.23"
AP_IP="$SUBNET.1"
HOSTAPD_CONF="/etc/hostapd/hostapd.conf"
DNSMASQ_CONF="/etc/dnsmasq.d/ap.conf"
FALLBACK_TIMEOUT=15

if [ "$EUID" -ne 0 ]; then
  echo "This script must be run as root (for example with sudo)."
  exit 1
fi

if [ -n "$1" ]; then
  MODE="$1"
else
  MODE="${wifi_mode}"
fi

# Get device ID from CPU serial (last 8 hex digits)
DEVICE_ID=$(awk '/Serial/ {print substr($NF, length($NF)-7)}' /proc/cpuinfo)
SSID="${NAME}-$DEVICE_ID"

switch_to_ap() {
  echo "Switching to AP mode"

  systemctl stop wpa_supplicant || true

  # Disable DHCP for wlan0 in dhcpcd.conf
  if ! grep -q "^denyinterfaces $INTERFACE" /etc/dhcpcd.conf; then
    echo "denyinterfaces $INTERFACE" > /etc/dhcpcd.conf.override
    cat /etc/dhcpcd.conf >> /etc/dhcpcd.conf.override
    mv /etc/dhcpcd.conf.override /etc/dhcpcd.conf
  fi
  systemctl restart dhcpcd

  ip link set "$INTERFACE" down
  ip addr flush dev "$INTERFACE"
  ip addr add "$AP_IP/24" dev "$INTERFACE"
  ip link set "$INTERFACE" up

  cat > "$HOSTAPD_CONF" <<EOF
interface=$INTERFACE
driver=nl80211
ssid=$SSID
hw_mode=g
channel=6
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=raspberry
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
EOF

  cat > "$DNSMASQ_CONF" <<EOF
interface=$INTERFACE
dhcp-range=$SUBNET.10,$SUBNET.50,255.255.255.0,24h
EOF

  sed -i 's|^#*DAEMON_CONF=.*|DAEMON_CONF="'"$HOSTAPD_CONF"'"|' /etc/default/hostapd

  systemctl restart dnsmasq
  systemctl unmask hostapd
  systemctl restart hostapd

  echo "AP mode enabled at $AP_IP with SSID: $SSID"
}

switch_to_client() {
  echo "Switching to client mode"

  systemctl stop hostapd || true
  systemctl stop dnsmasq || true

  # Make sure wlan0 can get an IP via DHCP
  sed -i "/^denyinterfaces $INTERFACE/d" /etc/dhcpcd.conf

  ip link set "$INTERFACE" down
  ip addr flush dev "$INTERFACE"
  ip link set "$INTERFACE" up

  systemctl start wpa_supplicant
  systemctl restart dhcpcd

  echo "Waiting up to $FALLBACK_TIMEOUT seconds for IP..."

  for i in $(seq 1 "$FALLBACK_TIMEOUT"); do
    if ip -4 addr show "$INTERFACE" | grep -q 'inet '; then
      echo "Client mode successful: IP assigned."
      return 0
    fi
    sleep 1
  done

  echo "Client mode failed after $FALLBACK_TIMEOUT seconds. Falling back to AP mode."
  switch_to_ap
}

if [ "$MODE" == "ap" ]; then
  switch_to_ap
elif [ "$MODE" == "client" ]; then
  switch_to_client
else
  echo "Usage: $0 [ap|client]"
  exit 1
fi

# Setup routes after switching
v3xctrl-route-manager "${wifi_routing}"

# If the web-interface is already active, restart it to bind to the new IP
if systemctl is-active --quiet v3xctrl-config-server; then
  systemctl restart v3xctrl-config-server
fi
