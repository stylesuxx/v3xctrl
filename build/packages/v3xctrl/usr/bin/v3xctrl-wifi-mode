#!/bin/bash

set -e

ENV_PATH="/run/v3xctrl.env"
source "${ENV_PATH}"

INTERFACE="wlan0"
SUBNET="192.168.23"
AP_IP="$SUBNET.1"
FALLBACK_TIMEOUT=15
AP_CONNECTION="v3xctrl-ap"

if [ "$EUID" -ne 0 ]; then
  echo "This script must be run as root (for example with sudo)."
  exit 1
fi

if [ -n "$1" ]; then
  MODE="$1"
else
  MODE="${network_wifi_mode}"
fi

# Get device ID from CPU serial (last 8 hex digits)
DEVICE_ID=$(awk '/Serial/ {print substr($NF, length($NF)-7)}' /proc/cpuinfo)
SSID="${NAME}-$DEVICE_ID"

setup_ap_connection() {
  # Check if AP connection already exists
  if nmcli connection show "$AP_CONNECTION" &>/dev/null; then
    echo "AP connection already exists"
    return 0
  fi

  echo "Creating AP connection profile..."

  # Create hotspot connection (NetworkManager handles DHCP/DNS automatically)
  nmcli connection add \
    type wifi \
    ifname "$INTERFACE" \
    con-name "$AP_CONNECTION" \
    autoconnect no \
    ssid "$SSID" \
    mode ap \
    ipv4.method shared \
    ipv4.addresses "$AP_IP/24"

  # Set WPA2 password
  nmcli connection modify "$AP_CONNECTION" \
    wifi-sec.key-mgmt wpa-psk \
    wifi-sec.psk "raspberry"

  # Set channel
  nmcli connection modify "$AP_CONNECTION" \
    802-11-wireless.band bg \
    802-11-wireless.channel 6
}

switch_to_ap() {
  echo "Switching to AP mode"

  # Ensure AP connection exists
  setup_ap_connection

  # Bring down any active connections on wlan0
  nmcli device disconnect "$INTERFACE" || true

  # Bring up AP
  nmcli connection up "$AP_CONNECTION"

  echo "AP mode enabled at $AP_IP with SSID: $SSID"
}

switch_to_client() {
  echo "Switching to client mode"

  # Bring down and DELETE AP connection
  if nmcli connection show "$AP_CONNECTION" &>/dev/null; then
    nmcli connection down "$AP_CONNECTION" 2>/dev/null || true
    nmcli connection delete "$AP_CONNECTION"
    echo "Deleted AP connection profile"
  fi

  # Check if already connected in client mode
  STATE=$(nmcli -t -f DEVICE,STATE device | grep -E "^$INTERFACE:" | grep -v '^p2p-' | cut -d: -f2)
  if [ "$STATE" = "connected" ]; then
    # Verify it's not connected to the AP (which should be deleted now anyway)
    CURRENT_CONN=$(nmcli -t -f DEVICE,CONNECTION device | grep "^$INTERFACE:" | cut -d: -f2)
    if [ "$CURRENT_CONN" != "$AP_CONNECTION" ] && [ -n "$CURRENT_CONN" ]; then
      IP=$(nmcli -t -f IP4.ADDRESS device show "$INTERFACE" | cut -d: -f2 | cut -d/ -f1)
      echo "Already connected to Wi-Fi ($CURRENT_CONN) with IP $IP. No further action needed."
      return 0
    fi
  fi

  # Get list of preconfigured Wi-Fi connections (excluding AP if it somehow still exists)
  WIFI_CONNECTIONS=$(nmcli -t -f TYPE,NAME connection show | grep "^802-11-wireless:" | grep -v ":$AP_CONNECTION$" | cut -d: -f2)

  if [ -z "$WIFI_CONNECTIONS" ]; then
    echo "No Wi-Fi networks configured. Falling back to AP mode."
    switch_to_ap
    return 0
  fi

  # Explicitly try to connect to the first available preconfigured network
  echo "Found preconfigured networks: $WIFI_CONNECTIONS"

  # Disconnect the interface first to ensure clean state
  nmcli device disconnect "$INTERFACE" || true

  # Try each preconfigured connection
  CONNECTED=false
  while IFS= read -r CONN; do
    echo "Attempting to connect to: $CONN"
    if nmcli connection up "$CONN" ifname "$INTERFACE" 2>/dev/null; then
      echo "Waiting up to $FALLBACK_TIMEOUT seconds for connection..."

      for i in $(seq 1 "$FALLBACK_TIMEOUT"); do
        STATE=$(nmcli -t -f DEVICE,STATE device | grep "^$INTERFACE:" | cut -d: -f2)
        if [ "$STATE" = "connected" ]; then
          IP=$(nmcli -t -f IP4.ADDRESS device show "$INTERFACE" | cut -d: -f2 | cut -d/ -f1)
          echo "Client mode successful: Connected to '$CONN' with IP $IP"
          CONNECTED=true
          break 2
        fi
        sleep 1
      done

      echo "Connection to '$CONN' timed out, trying next..."
    fi
  done <<< "$WIFI_CONNECTIONS"

  if [ "$CONNECTED" = false ]; then
    echo "Client mode failed after trying all networks. Falling back to AP mode."
    switch_to_ap
    return 0
  fi
}

if [ "$MODE" == "ap" ]; then
  switch_to_ap
elif [ "$MODE" == "client" ]; then
  switch_to_client
else
  echo "Usage: $0 [ap|client]"
  exit 1
fi

# Setup routes after switching
v3xctrl-route-manager "${network_wifi_routing}"

# If the web-interface is already active, restart it to bind to the new IP
if systemctl is-active --quiet v3xctrl-config-server; then
  systemctl restart v3xctrl-config-server
fi
