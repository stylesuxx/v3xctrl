<!DOCTYPE html>
<html>
  <head>
    <title>V3XCTRL Config Editor</title>
    <script src="{{ url_for('static', filename='libs/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='libs/jsoneditor.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='libs/bootstrap3.min.css') }}">
  </head>

  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <nav class="navbar navbar-default">
            <div class="container-fluid">
              <div class="navbar-header">
                <a class="navbar-brand" href="#">v3xctrl</a>
              </div>

              <ul class="nav navbar-nav">
                <li>
                  <a class="reboot" href="">Restart</a>
                </li>
              </ul>

              <ul class="nav navbar-nav navbar-right">
                <li>
                  <a href="https://discord.gg/uF4hf8UBBW">Join us on Discord!</a>
                </li>
              </ul>
            </div>
          </nav>
        </div>
      </div>

      <ul class="nav nav-tabs" role="tablist" id="custom-tabs">
        <li class="active"><a href="#editor-tab" role="tab" data-toggle="tab">Config Editor</a></li>
        <li><a href="#services-tab" role="tab" data-toggle="tab">Services</a></li>
      </ul>

      <div class="tab-content" style="margin-top: 20px;">
        <div class="tab-pane active" id="editor-tab">
          <div id="editor_holder"></div>
          <button id="save" class="btn btn-primary">Save</button>
          <div id="response" class="alert alert-success mt-3" style="display: none; margin-top: 15px;"></div>
        </div>

        <div class="tab-pane" id="services-tab">
          <div id="service_status_container">
            <p>Loading service states...</p>
          </div>
        </div>
      </div>
    </div>

    <div id="reboot-backdrop" class="modal-backdrop fade hidden"></div>

    <div id="rebootModal" class="modal fade hidden" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content text-center" style="padding: 20px;">
          <h2>Rebooting...</h2>
          <p><span id="reboot-countdown">60</span> seconds</p>
        </div>
      </div>
    </div>

    <script>
      const schema = {{ schema|tojson }};
      const startval = {{ config|tojson }};

      const editor = new JSONEditor(document.getElementById('editor_holder'), {
        schema: schema,
        startval: startval,
        theme: 'bootstrap3'
      });

      $('#save').on('click', function() {
        $('#response').text("");
        const updatedData = editor.getValue();
        const errors = editor.validate();

        if(errors.length ==0) {
          $.ajax({
            url: '/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updatedData),
            success: function(res) {
                $messageContainer = $('#response');
                $messageContainer.text(res.message);
                $messageContainer.stop(true, true)
                  .fadeIn(200)
                  .delay(2000)
                  .fadeOut(600);
            }
          });
        }
      });

      $('a.reboot').on('click', function(e) {
        e.preventDefault();

        const $modal = $('#rebootModal');
        const $backdrop = $('#reboot-backdrop');
        const $countdown = $('#reboot-countdown');
        let secondsLeft = 30;

        $modal.removeClass('hidden fade').addClass('in').css({
          display: 'block',
          opacity: 1
        });
        $backdrop.removeClass('hidden fade').addClass('in').css({
          display: 'block',
          opacity: 0.5
        });
        $('body').addClass('modal-open');

        $countdown.text(secondsLeft);

        const countdownTimer = setInterval(function() {
          secondsLeft--;
          $countdown.text(secondsLeft);

          if (secondsLeft <= 0) {
            clearInterval(countdownTimer);
            location.reload();
          }
        }, 1000);

        $.post('/reboot').fail(function() {
          console.warn("Reboot POST failed â€” likely already rebooting.");
        });
      });


      $('#custom-tabs a').on('click', function(e) {
        e.preventDefault();

        $('#custom-tabs li').removeClass('active');
        $(this).parent().addClass('active');

        $('.tab-pane').hide();
        $($(this).attr('href')).show();

        // Load service status if needed
        if ($(this).attr('href') === '#services-tab') {
          $.get('/services', function(data) {
            const container = $('#service_status_container');
            container.empty();

            if (data.services && data.services.length > 0) {
              data.services.forEach(service => {
                const statusClass = service.active ? 'text-success' : 'text-danger';
                container.append(
                  `<p><strong>${service.name} (${service.type})</strong>: <span class="${statusClass}">${service.active ? 'Active' : 'Inactive'}</span></p>`
                );
              });
            } else {
              container.text('No service info available.');
            }
          });
        }
      });
    </script>

  </body>
</html>
